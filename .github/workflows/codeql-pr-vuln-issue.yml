name: Create Issue on Vulnerability in PR

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  scan-and-create-issue:
    runs-on: ubuntu-latest
    permissions:
      security-events: read   # For CodeQL
      contents: write         # To create issues
      issues: write           # To create issues

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup GitHub CLI
      uses: cli/gh-action@v2

    - name: Authenticate GitHub CLI
      run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: 'javascript,python' # adjust as needed

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    - name: Check for Vulnerabilities
      id: check_vulns
      run: |
        gh api \
          -H "Accept: application/vnd.github+json" \
          /repos/${{ github.repository }}/security/alerts \
          > alerts.json
        if [ "$(jq '. | length' alerts.json)" -gt "0" ]; then
          echo "vulnerabilities found"
          jq '.' alerts.json > ISSUE_BODY.md
          echo "vuln_found=true" >> $GITHUB_OUTPUT
        else
          echo "No vulnerabilities found"
          echo "vuln_found=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Issue from File
      if: steps.check_vulns.outputs.vuln_found == 'true'
      uses: peter-evans/create-issue-from-file@v5
      with:
        title: "Security Vulnerability Detected in PR #${{ github.event.pull_request.number }}"
        content-filepath: ISSUE_BODY.md
        labels: "security, automated"
